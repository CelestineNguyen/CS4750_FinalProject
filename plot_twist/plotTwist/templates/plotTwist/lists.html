{% extends "base.html" %}
{% block title %}Your Book Lists{% endblock %}


{% block content %}
<h1>Your Lists</h1>

<!-- Search Bar -->
<input type="text" id="searchInput" placeholder="Search by book, author, or list name..." style="width: 90%; padding: 8px; margin-bottom: 1rem;" onkeyup="filterLists()">

<!-- Create new list form -->
<form method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Create New List</button>
</form>

{% if messages %}
    {% for message in messages %}
        <p class="alert {{ message.tags }}">{{ message }}</p>
    {% endfor %}
{% endif %}
<hr>

<!-- Update Lists Button -->
<button id="edit-toggle" onclick="toggleEditMode()">Update Lists</button>




{% if user_lists %}
    {% for list in user_lists %}
        <div class="list-block" data-list-id="{{ list.list_id }}">
            <!-- Editable List Name -->
            <form method="POST" action="{% url 'rename_list' list.list_id %}" class="rename-form">
                {% csrf_token %}
                <h2 class="list-title">
                    <span class="display-name">{{ list.list_name }}</span>
                    <input class="edit-name" type="text" name="new_name" value="{{ list.list_name }}" style="display:none;" />
                    <button class="save-name" type="submit" style="display:none;">Save</button>
                </h2>
            </form>

            <!-- Delete Entire List -->
            <form method="POST" action="{% url 'delete_list' list.list_id %}" onsubmit="return confirmDelete()" style="display:none;" class="delete-list-form">
                {% csrf_token %}
                <button type="submit" class="delete-list-btn">❌</button>
            </form>

            <!-- Books -->
            <ul>
                {% for item in list.listbooks_set.all %}
                    <li>
                        {{ item.book.title }} by {{ item.book.authors }}
                        <form method="POST" action="{% url 'remove_book' list.list_id item.book.book_id %}" class="delete-book-form" style="display:none; display:inline-block;">
                            {% csrf_token %}
                            <button type="submit" class="delete-book-btn">❌</button>
                        </form>
                    </li>
                {% empty %}
                    <li>No books in this list yet.</li>
                {% endfor %}
            </ul>
        </div>
        <hr>
    {% endfor %}
{% else %}
    <p>You have no lists yet.</p>
{% endif %}

<script>
    function filterLists() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const lists = document.querySelectorAll(".list-block");
    
        lists.forEach(list => {
            const listName = list.querySelector(".list-title").innerText.toLowerCase();
            const books = list.querySelectorAll("li");
    
            let matchFound = listName.includes(input);
    
            // Check if any book in this list matches
            books.forEach(book => {
                const bookText = book.innerText.toLowerCase();
                if (bookText.includes(input)) {
                    matchFound = true;
                }
            });
    
            // If match found, show entire list (and all books in it)
            list.style.display = matchFound ? "block" : "none";
    
            // Always show all books inside visible lists
            if (matchFound) {
                books.forEach(book => {
                    book.style.display = "list-item";
                });
            }
        });
    }
</script>
    
    

<style>
button.delete-book-btn,
button.delete-list-btn {
    margin-left: 8px;
    color: red;
    font-weight: bold;
    background: none;
    border: none;
    cursor: pointer;
}
button.delete-book-btn:hover,
button.delete-list-btn:hover {
    text-decoration: underline;
}
</style>

{% endblock %}
